<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Billing Application</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        input[type="text"],
        input[type="number"],
        textarea {
            padding: 0.6rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
            color: #333;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        tr:hover {
            background-color: #f3f4f6;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6b7280;
        }
        .close-button:hover {
            color: #333;
        }
        .invoice-preview {
            padding: 2rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
            margin-top: 1.5rem;
        }
        .invoice-header, .invoice-footer {
            text-align: center;
            margin-bottom: 1rem;
        }
        .invoice-details, .invoice-items {
            margin-bottom: 1rem;
        }
        .invoice-items table {
            border: 1px solid #e5e7eb;
        }
        .invoice-items th, .invoice-items td {
            border: 1px solid #e5e7eb;
        }
        .invoice-total {
            text-align: right;
            font-weight: 700;
            font-size: 1.2rem;
            margin-top: 1rem;
        }
        .user-id-display {
            background-color: #e0e7ff;
            color: #4f46e5;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Shop Billing Application</h1>

        <!-- User ID Display -->
        <div class="user-id-display">
            Your User ID: <span id="userIdDisplay">Loading...</span>
        </div>

        <!-- Product Management Section -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Product Management</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="productName" placeholder="Enter product name">
                </div>
                <div>
                    <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">Price (INR)</label>
                    <input type="number" id="productPrice" placeholder="Enter price" min="0" step="0.01">
                </div>
                <div>
                    <label for="productStock" class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
                    <input type="number" id="productStock" placeholder="Enter stock" min="0" step="1">
                </div>
            </div>
            <button id="addProductBtn" class="btn btn-primary w-full md:w-auto">Add Product</button>

            <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-700">Available Products</h3>
            <div class="overflow-x-auto">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Create New Bill</h2>
            <div class="mb-4">
                <label for="searchProduct" class="block text-sm font-medium text-gray-700 mb-1">Search Product</label>
                <input type="text" id="searchProduct" placeholder="Search by product name">
            </div>
            <div class="overflow-x-auto mb-6">
                <table id="billingProductsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Quantity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Search results will be loaded here -->
                    </tbody>
                </table>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-gray-700">Items in Cart</h3>
            <div class="overflow-x-auto mb-6">
                <table id="cartItemsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Cart items will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="text-right text-2xl font-bold text-gray-800 mb-6">
                Total Amount: <span id="totalAmount">0.00</span> INR
            </div>

            <button id="generateBillBtn" class="btn btn-primary w-full md:w-auto">Generate Bill</button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Product</h3>
                <button class="close-button" onclick="closeModal('editProductModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProductId">
                <div class="mb-4">
                    <label for="editProductName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="editProductName">
                </div>
                <div class="mb-4">
                    <label for="editProductPrice" class="block text-sm font-medium text-gray-700 mb-1">Price (INR)</label>
                    <input type="number" id="editProductPrice" min="0" step="0.01">
                </div>
                <div class="mb-4">
                    <label for="editProductStock" class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
                    <input type="number" id="editProductStock" min="0" step="1">
                </div>
                <button id="saveProductBtn" class="btn btn-primary w-full">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invoice Preview</h3>
                <button class="close-button" onclick="closeModal('invoicePreviewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoiceContent" class="invoice-preview">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="printInvoiceBtn" class="btn btn-secondary">Print Invoice</button>
                    <button id="confirmPurchaseBtn" class="btn btn-primary">Confirm Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageModalTitle"></h3>
                <button class="close-button" onclick="closeModal('messageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="messageModalBody"></p>
            </div>
            <div class="modal-footer flex justify-end mt-4">
                <button class="btn btn-primary" onclick="closeModal('messageModal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let productsCollectionRef;
        let salesCollectionRef;
        let productsData = []; // Cache for all products
        let cart = []; // Array to hold items in the current bill

        // --- Utility Functions ---
        function showModal(modalId, title = '', body = '') {
            const modal = document.getElementById(modalId);
            if (modalId === 'messageModal') {
                document.getElementById('messageModalTitle').textContent = title;
                document.getElementById('messageModalBody').textContent = body;
            }
            modal.classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showMessage(title, message) {
            showModal('messageModal', title, message);
        }

        // --- Authentication and Firestore Setup ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('userIdDisplay').textContent = currentUserId;
                // Define Firestore collection references based on user ID and app ID
                productsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/products`);
                salesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/sales`);
                console.log("Firestore initialized for user:", currentUserId);
                // Load products and set up real-time listener
                listenToProducts();
            } else {
                // Sign in anonymously if no token, or with custom token if available
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during authentication:", error);
                    showMessage("Authentication Error", "Failed to sign in. Please try again.");
                }
            }
        });

        // --- Product Management Functions ---
        async function addProduct() {
            if (!currentUserId) {
                showMessage("Error", "User not authenticated. Please wait.");
                return;
            }

            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);

            if (!name || isNaN(price) || price < 0 || isNaN(stock) || stock < 0) {
                showMessage("Input Error", "Please enter valid product name, price, and stock.");
                return;
            }

            try {
                await addDoc(productsCollectionRef, {
                    name: name,
                    price: price,
                    stock: stock,
                    createdAt: new Date()
                });
                showMessage("Success", "Product added successfully!");
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productStock').value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error", "Failed to add product: " + e.message);
            }
        }

        async function updateProduct() {
            if (!currentUserId) {
                showMessage("Error", "User not authenticated. Please wait.");
                return;
            }

            const id = document.getElementById('editProductId').value;
            const name = document.getElementById('editProductName').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const stock = parseInt(document.getElementById('editProductStock').value);

            if (!name || isNaN(price) || price < 0 || isNaN(stock) || stock < 0) {
                showMessage("Input Error", "Please enter valid product name, price, and stock for editing.");
                return;
            }

            try {
                const productDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products`, id);
                await updateDoc(productDocRef, {
                    name: name,
                    price: price,
                    stock: stock
                });
                showMessage("Success", "Product updated successfully!");
                closeModal('editProductModal');
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage("Error", "Failed to update product: " + e.message);
            }
        }

        async function deleteProduct(id) {
            if (!currentUserId) {
                showMessage("Error", "User not authenticated. Please wait.");
                return;
            }

            if (!confirm("Are you sure you want to delete this product?")) { // Using confirm for simplicity, ideally a custom modal
                return;
            }

            try {
                const productDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products`, id);
                await deleteDoc(productDocRef);
                showMessage("Success", "Product deleted successfully!");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Error", "Failed to delete product: " + e.message);
            }
        }

        function listenToProducts() {
            if (!productsCollectionRef) return;

            onSnapshot(productsCollectionRef, (snapshot) => {
                productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductsTable(productsData);
                renderBillingProductsTable(productsData); // Also update billing search table
            }, (error) => {
                console.error("Error listening to products: ", error);
                showMessage("Error", "Failed to load products: " + error.message);
            });
        }

        function renderProductsTable(products) {
            const tableBody = document.getElementById('productsTable').querySelector('tbody');
            tableBody.innerHTML = '';
            products.forEach(product => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = product.name;
                row.insertCell(1).textContent = product.price.toFixed(2);
                row.insertCell(2).textContent = product.stock;

                const actionsCell = row.insertCell(3);
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'btn btn-secondary text-sm mr-2';
                editBtn.onclick = () => openEditProductModal(product);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'btn btn-danger text-sm';
                deleteBtn.onclick = () => deleteProduct(product.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function openEditProductModal(product) {
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductStock').value = product.stock;
            showModal('editProductModal');
        }

        // --- Billing Functions ---
        function renderBillingProductsTable(products) {
            const tableBody = document.getElementById('billingProductsTable').querySelector('tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();

            const filteredProducts = products.filter(product =>
                product.name.toLowerCase().includes(searchTerm)
            );

            filteredProducts.forEach(product => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = product.name;
                row.insertCell(1).textContent = product.price.toFixed(2);
                row.insertCell(2).textContent = product.stock;

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = 1;
                quantityInput.min = 1;
                quantityInput.max = product.stock;
                quantityInput.className = 'w-24 p-1 border rounded';
                row.insertCell(3).appendChild(quantityInput);

                const actionsCell = row.insertCell(4);
                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add to Cart';
                addBtn.className = 'btn btn-primary text-sm';
                addBtn.onclick = () => addToCart(product, parseInt(quantityInput.value));
                actionsCell.appendChild(addBtn);
            });
        }

        function addToCart(product, quantity) {
            if (quantity <= 0 || quantity > product.stock) {
                showMessage("Invalid Quantity", `Please enter a quantity between 1 and ${product.stock} for ${product.name}.`);
                return;
            }

            const existingCartItemIndex = cart.findIndex(item => item.id === product.id);

            if (existingCartItemIndex > -1) {
                // If item already in cart, update quantity
                const newQuantity = cart[existingCartItemIndex].quantity + quantity;
                if (newQuantity > product.stock) {
                    showMessage("Stock Limit", `Cannot add ${quantity} more of ${product.name}. Only ${product.stock - cart[existingCartItemIndex].quantity} available.`);
                    return;
                }
                cart[existingCartItemIndex].quantity = newQuantity;
            } else {
                // Add new item to cart
                cart.push({ ...product, quantity: quantity });
            }
            showMessage("Added to Cart", `${quantity} x ${product.name} added to cart.`);
            renderCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
        }

        function updateCartItemQuantity(productId, newQuantity) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const productInStock = productsData.find(p => p.id === productId);
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                    return;
                }
                if (newQuantity > productInStock.stock) {
                    showMessage("Stock Limit", `Cannot set quantity to ${newQuantity} for ${productInStock.name}. Only ${productInStock.stock} available.`);
                    cart[itemIndex].quantity = productInStock.stock; // Set to max available
                } else {
                    cart[itemIndex].quantity = newQuantity;
                }
                renderCart();
            }
        }

        function renderCart() {
            const tableBody = document.getElementById('cartItemsTable').querySelector('tbody');
            tableBody.innerHTML = '';
            let totalAmount = 0;

            if (cart.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.textContent = 'No items in cart.';
                cell.className = 'text-center text-gray-500 py-4';
            } else {
                cart.forEach(item => {
                    const row = tableBody.insertRow();
                    const itemTotal = item.price * item.quantity;
                    totalAmount += itemTotal;

                    row.insertCell(0).textContent = item.name;
                    row.insertCell(1).textContent = item.price.toFixed(2);

                    const quantityCell = row.insertCell(2);
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.value = item.quantity;
                    quantityInput.min = 1;
                    quantityInput.className = 'w-24 p-1 border rounded';
                    quantityInput.onchange = (e) => updateCartItemQuantity(item.id, parseInt(e.target.value));
                    quantityCell.appendChild(quantityInput);

                    row.insertCell(3).textContent = itemTotal.toFixed(2);

                    const actionsCell = row.insertCell(4);
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.className = 'btn btn-danger text-sm';
                    removeBtn.onclick = () => removeFromCart(item.id);
                    actionsCell.appendChild(removeBtn);
                });
            }
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
        }

        function generateInvoiceContent() {
            if (cart.length === 0) {
                showMessage("Empty Cart", "Please add items to the cart before generating a bill.");
                return '';
            }

            let invoiceHtml = `
                <div class="invoice-header">
                    <h2 class="text-2xl font-bold">Invoice</h2>
                    <p>Date: ${new Date().toLocaleDateString()}</p>
                    <p>Time: ${new Date().toLocaleTimeString()}</p>
                    <p>Bill ID: ${Math.random().toString(36).substring(2, 10).toUpperCase()}</p>
                </div>
                <div class="invoice-details mb-4">
                    <p><strong>Shop Name:</strong> Your Shop Name</p>
                    <p><strong>Address:</strong> 123 Main Street, City, State, ZIP</p>
                    <p><strong>Phone:</strong> +91 9876543210</p>
                    <p><strong>GSTIN:</strong> ABCDE12345FGHIJ</p>
                </div>
                <div class="invoice-items">
                    <table class="w-full text-sm">
                        <thead>
                            <tr>
                                <th class="py-2 px-3 bg-gray-200">Item</th>
                                <th class="py-2 px-3 bg-gray-200 text-right">Price</th>
                                <th class="py-2 px-3 bg-gray-200 text-right">Qty</th>
                                <th class="py-2 px-3 bg-gray-200 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            let subtotal = 0;
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                invoiceHtml += `
                            <tr>
                                <td class="py-2 px-3">${item.name}</td>
                                <td class="py-2 px-3 text-right">${item.price.toFixed(2)}</td>
                                <td class="py-2 px-3 text-right">${item.quantity}</td>
                                <td class="py-2 px-3 text-right">${itemTotal.toFixed(2)}</td>
                            </tr>
                `;
            });

            // Assuming a simple GST calculation for demonstration (e.g., 18%)
            const gstRate = 0.18;
            const gstAmount = subtotal * gstRate;
            const grandTotal = subtotal + gstAmount;

            invoiceHtml += `
                        </tbody>
                    </table>
                </div>
                <div class="invoice-summary text-right mt-4">
                    <p><strong>Subtotal:</strong> ${subtotal.toFixed(2)} INR</p>
                    <p><strong>GST (${(gstRate * 100).toFixed(0)}%):</strong> ${gstAmount.toFixed(2)} INR</p>
                    <p class="invoice-total"><strong>Grand Total:</strong> ${grandTotal.toFixed(2)} INR</p>
                </div>
                <div class="invoice-footer mt-6 text-gray-600 text-sm">
                    <p>Thank you for your purchase!</p>
                    <p>Please visit us again.</p>
                </div>
            `;
            return invoiceHtml;
        }

        async function confirmPurchase() {
            if (!currentUserId) {
                showMessage("Error", "User not authenticated. Please wait.");
                return;
            }

            if (cart.length === 0) {
                showMessage("Empty Cart", "No items to confirm purchase for.");
                return;
            }

            try {
                // 1. Update product stock in Firestore
                const batch = db.batch();
                let stockUpdatePromises = [];

                for (const item of cart) {
                    const productRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products`, item.id);
                    const currentProductDoc = await getDoc(productRef); // Get current stock
                    if (currentProductDoc.exists()) {
                        const currentStock = currentProductDoc.data().stock;
                        const newStock = currentStock - item.quantity;
                        if (newStock < 0) {
                            showMessage("Stock Error", `Not enough stock for ${item.name}. Available: ${currentStock}, Requested: ${item.quantity}.`);
                            return; // Stop the process if stock is insufficient for any item
                        }
                        batch.update(productRef, { stock: newStock });
                    } else {
                        showMessage("Error", `Product ${item.name} not found in inventory.`);
                        return; // Stop if product not found
                    }
                }

                // 2. Record the sale in Firestore
                const saleData = {
                    items: cart.map(item => ({
                        productId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        itemTotal: item.price * item.quantity
                    })),
                    totalAmount: parseFloat(document.getElementById('totalAmount').textContent),
                    saleDate: new Date(),
                    userId: currentUserId
                };
                const salesDocRef = doc(salesCollectionRef); // Create a new document reference
                batch.set(salesDocRef, saleData); // Add to batch

                // Commit the batch
                await batch.commit();

                showMessage("Purchase Confirmed", "Stock updated and sale recorded successfully!");
                cart = []; // Clear cart after successful purchase
                renderCart();
                closeModal('invoicePreviewModal');
            } catch (e) {
                console.error("Error confirming purchase: ", e);
                showMessage("Error", "Failed to confirm purchase: " + e.message);
            }
        }

        // --- Event Listeners ---
        document.getElementById('addProductBtn').addEventListener('click', addProduct);
        document.getElementById('saveProductBtn').addEventListener('click', updateProduct);
        document.getElementById('searchProduct').addEventListener('input', () => renderBillingProductsTable(productsData));
        document.getElementById('generateBillBtn').addEventListener('click', () => {
            const invoiceHtml = generateInvoiceContent();
            if (invoiceHtml) {
                document.getElementById('invoiceContent').innerHTML = invoiceHtml;
                showModal('invoicePreviewModal');
            }
        });
        document.getElementById('printInvoiceBtn').addEventListener('click', () => {
            const printContent = document.getElementById('invoiceContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Invoice</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Inter', sans-serif; margin: 20px; }
                .invoice-preview { padding: 1rem; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }
                .invoice-header, .invoice-footer { text-align: center; margin-bottom: 1rem; }
                .invoice-items table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                .invoice-items th, .invoice-items td { padding: 8px; text-align: left; border: 1px solid #ddd; }
                .invoice-total { text-align: right; font-weight: bold; font-size: 1.2rem; margin-top: 1rem; }
                @media print {
                    body { margin: 0; }
                    .invoice-preview { box-shadow: none; border: none; }
                }
            `);
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        });
        document.getElementById('confirmPurchaseBtn').addEventListener('click', confirmPurchase);

        // Initial render of cart (empty)
        renderCart();
    </script>
</body>
</html>
